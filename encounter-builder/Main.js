"use strict";var F=Object.defineProperty;var st=Object.getOwnPropertyDescriptor;var it=Object.getOwnPropertyNames;var rt=Object.prototype.hasOwnProperty;var ot=(E,C)=>{for(var e in C)F(E,e,{get:C[e],enumerable:!0})},at=(E,C,e,s)=>{if(C&&typeof C=="object"||typeof C=="function")for(let t of it(C))!rt.call(E,t)&&t!==e&&F(E,t,{get:()=>C[t],enumerable:!(s=st(C,t))||s.enumerable});return E};var lt=E=>at(F({},"__esModule",{value:!0}),E);var pt={};ot(pt,{default:()=>ht});module.exports=lt(pt);var p=require("obsidian"),ct=0,ut=1,dt=2,j=3;function J(E){let C=E.trim().split(`
`),e=[],s=!1,t=0,n=0,r=0;for(let i of C){let c=i.trim();if(!c||c.indexOf("|")===-1||c.replace(/[\|\-\s]/g,"").length===0||c.includes(":---")){c.includes("---")&&(s=!0);continue}if(!s&&(c.toLowerCase().includes("creature")||c.toLowerCase().includes("cr"))){s=!0;continue}if(c.toLowerCase().includes("total"))continue;let o=c.split("|").map(u=>u.trim());if(o[0]===""&&o.shift(),o[o.length-1]===""&&o.pop(),o.length>=j+1){let u=parseInt(o[ct],10)||1,d=o[ut],l=o[dt],m=o[j],h=0;if(l)if(l.includes("/")){let f=l.split("/");f.length===2&&!isNaN(parseFloat(f[0]))&&!isNaN(parseFloat(f[1]))&&parseFloat(f[1])!==0?h=parseFloat(f[0])/parseFloat(f[1]):(console.warn(`EB: Bad fraction CR: ${l}`),h=0)}else{let f=parseFloat(l);isNaN(f)?(typeof l=="string"&&l.toLowerCase()!=="varies"&&console.warn(`EB: Bad number CR: ${l}`),h=0):h=f}else console.warn(`EB: Missing CR: ${c}`),h=0;let g=parseInt(m.replace(/,/g,""),10)||0;u>0&&d&&(e.push({quantity:u,name:d,cr:l,crText:l,xp:g}),t+=u*g,r+=u*h,n=Math.max(n,h))}else console.warn(`EB: Skipping row, bad columns: ${c}`)}let a=null;for(let i of C){let c=i.trim();if(c.toLowerCase().includes("total")){let o=c.split("|").map(u=>u.trim());o[0]===""&&o.shift(),o[o.length-1]===""&&o.pop();for(let u=o.length-1;u>=0;u--){let d=o[u];if(d&&d.length>0){let l=d.match(/(\d[\d,]*)/);if(l&&l[1]){let m=parseInt(l[1].replace(/,/g,""),10);if(!isNaN(m)){a=m;break}}}}if(a!==null)break}}return{creatures:e,totalXP:a!==null?a:t,totalCR:r,highestCR:n}}var $=class extends p.Modal{constructor(e,s,t=!1,n,r,a){super(e);this.plugin=s,this.isEditing=t,this.creatures=n?JSON.parse(JSON.stringify(n)):[],this.sectionInfo=r!=null?r:null,this.sourcePath=a!=null?a:null,this.monsterFiles=[]}onOpen(){this.contentEl.empty(),this.contentEl.createEl("h2",{text:this.isEditing?"Edit Encounter":"Create Encounter"});let e=this.contentEl.createDiv({cls:"encounter-form"}),s=e.createDiv();s.createEl("label",{text:"Quantity:"}),this.quantityInput=s.createEl("input",{type:"number",value:"1"}),this.quantityInput.min="1";let t=e.createDiv();t.createEl("label",{text:"Creature:"}),this.nameContainer=t.createEl("div",{cls:"encounter-creature-input-container"}),this.nameInput=this.nameContainer.createEl("input",{type:"text",placeholder:"Enter creature name..."});let n=this.nameContainer.createEl("button",{text:"Lookup CR/XP"});n.addClass("mod-cta"),n.addEventListener("click",()=>this.lookupCreature());let r=e.createDiv();r.createEl("label",{text:"CR:"}),this.crInput=r.createEl("input",{type:"text",placeholder:"Lookup or enter manually"});let a=e.createDiv();a.createEl("label",{text:"XP:"}),this.xpInput=a.createEl("input",{type:"number",placeholder:"Lookup or enter manually"}),this.xpInput.min="0",e.createEl("button",{text:"Add Creature to List"}).addEventListener("click",()=>this.addCreature()),this.listEl=this.contentEl.createDiv({cls:"encounter-creature-list"}),this.renderCreatureList();let c=this.contentEl.createDiv({cls:"encounter-button-container"}),o=c.createEl("button",{text:this.isEditing?"Save Changes":"Create Encounter Table"});o.addClass("mod-cta"),o.addEventListener("click",()=>this.createEncounter()),c.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),c.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),this.setupAutocomplete(),this.addQuickAddSection(),this.setupKeyboardNavigation(),setTimeout(()=>this.nameInput.focus(),50)}setupKeyboardNavigation(){this.nameInput.addEventListener("keydown",async e=>{var s,t;if(e.key==="Enter"){let n=(s=this.suggestionContainer)==null?void 0:s.querySelector(".selected");if(((t=this.suggestionContainer)==null?void 0:t.style.display)!=="none"&&n)return;e.preventDefault(),await this.lookupCreature(),(this.crInput.value||this.xpInput.value)&&this.quantityInput.focus()}}),this.quantityInput.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),this.nameInput.focus())}),this.crInput.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),this.xpInput.focus())}),this.xpInput.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),this.addOrUpdateCreature())})}setupAutocomplete(){this.suggestionContainer=this.nameContainer.createDiv({cls:"encounter-suggestions"}),this.suggestionContainer.style.display="none";let s=[this.plugin.settings.monsterLocation1,this.plugin.settings.monsterLocation2,this.plugin.settings.monsterLocation3].filter(t=>t&&t.trim()!=="").map(t=>t.endsWith("/")?t:t+"/");this.monsterFiles=this.app.vault.getMarkdownFiles().filter(t=>s.length===0?t.path.includes("/bestiary/")&&(t.path.includes("z_compendium/")||t.path.includes("2024_z_compendium/")):s.some(n=>t.path.startsWith(n))),this.debouncedSearch=this.debounce(()=>{let t=this.nameInput.value.trim().toLowerCase();if(t.length<2){this.suggestionContainer.style.display="none";return}let n=this.monsterFiles.filter(r=>r.basename.toLowerCase().includes(t)).sort((r,a)=>{let i=r.basename.toLowerCase()===t,c=a.basename.toLowerCase()===t,o=r.path.includes("2024"),u=a.path.includes("2024");return i!==c?i?-1:1:o!==u?o?-1:1:r.basename.toLowerCase().localeCompare(a.basename.toLowerCase())}).slice(0,7);if(this.suggestionContainer.empty(),n.length===0){this.suggestionContainer.style.display="none";return}n.forEach(r=>{let a=r.path.includes("2024")?" (2024)":"";this.suggestionContainer.createDiv({cls:"encounter-suggestion-item",text:r.basename+a}).addEventListener("click",()=>{this.nameInput.value=r.basename,this.suggestionContainer.style.display="none",this.lookupCreature()})}),this.suggestionContainer.style.display="block"},300),this.nameInput.addEventListener("input",()=>{this.debouncedSearch()}),document.addEventListener("click",t=>{this.nameContainer&&!this.nameContainer.contains(t.target)&&this.suggestionContainer&&(this.suggestionContainer.style.display="none")},!0),this.nameInput.addEventListener("keydown",t=>{var c,o,u,d;if(this.suggestionContainer.style.display==="none")return;let n=this.suggestionContainer.querySelectorAll(".encounter-suggestion-item");if(n.length===0)return;let r=this.suggestionContainer.querySelector(".selected"),a=r?Array.from(n).indexOf(r):-1,i=a;switch(t.key){case"ArrowDown":t.preventDefault(),i=Math.min(a+1,n.length-1);break;case"ArrowUp":t.preventDefault(),i=Math.max(a-1,0);break;case"Enter":r&&(t.preventDefault(),this.nameInput.value=(o=(c=r.textContent)==null?void 0:c.replace(" (2024)","").trim())!=null?o:"",this.suggestionContainer.style.display="none",this.lookupCreature());return;case"Escape":t.preventDefault(),this.suggestionContainer.style.display="none";return}i!==a&&(r&&r.removeClass("selected"),(u=n[i])==null||u.addClass("selected"),(d=n[i])==null||d.scrollIntoView({block:"nearest"}))})}debounce(e,s){let t=null;return()=>{t!==null&&clearTimeout(t),t=window.setTimeout(()=>{e(),t=null},s)}}async lookupCreature(){let e=this.nameInput.value.trim();if(!e){new p.Notice("Please enter a creature name.");return}this.crInput.value="",this.xpInput.value="";let s=new p.Notice(`Looking up '${e}'...`,0);try{let t=await this.plugin.lookupCreatureStats(e);s.hide(),(t==null?void 0:t.cr)!==void 0&&t.xp!==void 0?(this.crInput.value=String(t.cr),this.xpInput.value=String(t.xp),new p.Notice(`Found: ${e} (CR ${t.cr}, ${t.xp} XP)`)):(this.nameInput.focus(),this.nameInput.select())}catch(t){s.hide(),console.error("EB Lookup Error:",t),new p.Notice(`Error looking up '${e}'.`),this.nameInput.focus(),this.nameInput.select()}}addOrUpdateCreature(){this.editingIndex!==void 0?this.updateCreature():this.addCreature()}addCreature(){let e=parseInt(this.quantityInput.value,10)||1,s=this.nameInput.value.trim(),t=this.crInput.value.trim(),n=this.xpInput.value.trim(),r=parseInt(n,10);if(!s){new p.Notice("Enter creature name."),this.nameInput.focus();return}if(!t){new p.Notice("Enter CR."),this.crInput.focus();return}if(!n||isNaN(r)||r<0){new p.Notice("Enter valid XP >= 0."),this.xpInput.focus();return}this.creatures.push({quantity:e,name:s,cr:t,crText:t,xp:r}),this.renderCreatureList(),this.resetForm(),this.nameInput.focus()}renderCreatureList(){if(this.listEl.empty(),this.creatures.length===0){this.listEl.createEl("p",{text:"No creatures added yet."});return}let e=this.listEl.createEl("table",{cls:"encounter-modal-table"}),t=e.createTHead().insertRow();["Qty","Creature","CR","XP","Total XP","Actions"].forEach(o=>t.createEl("th",{text:o}));let n=e.createTBody(),r=0;this.creatures.forEach((o,u)=>{let d=n.insertRow(),l=o.quantity*o.xp;r+=l,d.insertCell().textContent=o.quantity.toString(),d.insertCell().textContent=o.name,d.insertCell().textContent=String(o.cr),d.insertCell().textContent=o.xp.toLocaleString(),d.insertCell().textContent=l.toLocaleString();let h=d.insertCell().createDiv({cls:"encounter-actions"});h.createEl("button",{text:"Edit"}).addEventListener("click",()=>this.editCreature(u)),h.createEl("button",{text:"Remove",cls:"mod-warning"}).addEventListener("click",()=>{let g=this.editingIndex===u;this.creatures.splice(u,1),this.renderCreatureList(),g&&this.resetFormAndButton()})});let i=e.createTFoot().insertRow();i.addClass("encounter-modal-total-row");let c=i.insertCell();c.textContent="TOTAL",c.colSpan=4,i.insertCell().textContent=r.toLocaleString(),i.insertCell()}editCreature(e){let s=this.creatures[e];if(!s)return;this.editingIndex=e,this.quantityInput.value=String(s.quantity),this.nameInput.value=s.name,this.crInput.value=String(s.cr),this.xpInput.value=String(s.xp);let t=this.contentEl.querySelector(".encounter-form > button:not(.mod-cta):not(.mod-warning)");if(t){t.textContent="Update Creature";let n=t.cloneNode(!0);t.replaceWith(n),n.addEventListener("click",()=>this.updateCreature())}this.quantityInput.focus(),this.quantityInput.select()}addQuickAddSection(){let e=this.contentEl.createDiv({cls:"encounter-quick-add"});e.createEl("h3",{text:"Quick Add Common Monsters"});let s=[{name:"Zombie",cr:"1/4",xp:50,source:"2024"},{name:"Skeleton",cr:"1/4",xp:50,source:"2024"},{name:"Goblin",cr:"1/4",xp:50,source:"2024"},{name:"Kobold",cr:"1/8",xp:25,source:"2024"},{name:"Orc",cr:"1/2",xp:100,source:"2024"},{name:"Bandit",cr:"1/8",xp:25,source:"2024"},{name:"Wolf",cr:"1/4",xp:50,source:"2024"},{name:"Giant Rat",cr:"1/8",xp:25,source:"2024"}].map(n=>{var r;return{...n,name:(r=n.name)!=null?r:"Unknown"}}),t=e.createDiv({cls:"encounter-quick-add-buttons"});s.forEach(n=>{let r=t.createEl("button",{text:`${n.name} (CR ${n.cr})`,cls:"encounter-quick-add-btn"});n.source==="2024"&&r.addClass("encounter-source-2024"),r.addEventListener("click",()=>{var a;this.nameInput.value=(a=n.name)!=null?a:"",this.crInput.value=String(n.cr),this.xpInput.value=String(n.xp),this.editingIndex!==void 0&&this.resetFormAndButton(),this.quantityInput.focus(),this.quantityInput.select()})})}updateCreature(){if(this.editingIndex===void 0)return;let e=parseInt(this.quantityInput.value,10)||1,s=this.nameInput.value.trim(),t=this.crInput.value.trim(),n=this.xpInput.value.trim(),r=parseInt(n,10);if(!s){new p.Notice("Enter creature name."),this.nameInput.focus();return}if(!t){new p.Notice("Enter CR."),this.crInput.focus();return}if(!n||isNaN(r)||r<0){new p.Notice("Enter valid XP >= 0."),this.xpInput.focus();return}this.creatures[this.editingIndex]={quantity:e,name:s,cr:t,crText:t,xp:r},this.renderCreatureList(),this.resetFormAndButton(),this.nameInput.focus()}resetForm(){this.quantityInput.value="1",this.nameInput.value="",this.crInput.value="",this.xpInput.value=""}resetFormAndButton(){this.resetForm(),this.editingIndex=void 0;let e=this.contentEl.querySelector(".encounter-form > button:not(.mod-cta):not(.mod-warning)");if(e){e.textContent="Add Creature to List";let s=e.cloneNode(!0);e.replaceWith(s),s.addEventListener("click",()=>this.addCreature())}}createEncounter(){var a;if(this.creatures.length===0){new p.Notice("Add at least one creature.");return}let e=`| Qty | Creature | CR | XP | Total XP |
`;e+=`|:----|:---------|:---|---:|---------:|
`;let s=0;this.creatures.forEach(i=>{let c=i.quantity*i.xp;s+=c;let o=i.name.trim();!o.startsWith("[[")&&!o.endsWith("]]")&&(o=`[[${o}]]`),e+=`| ${i.quantity} | ${o} | ${i.cr} | ${i.xp.toLocaleString()} | ${c.toLocaleString()} |
`}),e+=`| **Total** | | | | **${s.toLocaleString()}** |
`;let t="```encounter\n"+e+"```\n",n=this.app.workspace.activeLeaf;if(!n||!(n.view instanceof p.MarkdownView)){new p.Notice("No active Markdown editor.");return}let r=n.view.editor;if(this.isEditing&&this.sectionInfo&&this.sourcePath===((a=n.view.file)==null?void 0:a.path)){console.log(`Attempting to replace range: Line ${this.sectionInfo.lineStart} to ${this.sectionInfo.lineEnd}`);try{r.replaceRange(t,{line:this.sectionInfo.lineStart,ch:0},{line:this.sectionInfo.lineEnd,ch:r.getLine(this.sectionInfo.lineEnd).length}),new p.Notice("Encounter block updated successfully.")}catch(i){console.error("EB: Error replacing range:",i),new p.Notice("Error updating block. Inserting at cursor instead. Please delete original."),r.replaceSelection(t)}}else r.replaceSelection(t),this.isEditing&&new p.Notice("Original block context lost or file changed. Updated encounter inserted at cursor. Please delete the original.");this.close()}onClose(){this.contentEl.empty()}},X=class extends p.Modal{constructor(e,s,t,n){super(e);this.plugin=s,this.files=t,this.onSelect=n}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Multiple Monsters Found"}),e.createEl("p",{text:"Multiple files match. Select the correct one:"});let s=e.createDiv({cls:"encounter-file-list"});this.files.forEach(t=>{let n=s.createDiv({cls:"encounter-file-item"}),r=n.createDiv();r.createEl("div",{cls:"encounter-file-name",text:t.basename}),r.createEl("div",{cls:"encounter-file-path",text:t.path}),n.createEl("button",{text:"Select",cls:"mod-cta"}).addEventListener("click",()=>{this.onSelect(t),this.close()})}),e.createDiv({cls:"encounter-button-container"}).createEl("button",{text:"Cancel"}).addEventListener("click",()=>{var t;(t=this.onCancel)==null||t.call(this),this.close()})}onClose(){this.contentEl.empty()}},q=class extends p.Modal{constructor(e,s,t,n){super(e);this.plugin=s,this.creatureName=t,this.onSubmit=n}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Enter Monster Stats"}),e.createEl("p",{text:`Could not parse CR/XP for "${this.creatureName}". Enter manually:`});let s=e.createDiv({cls:"encounter-manual-form"}),t=s.createDiv();t.createEl("label",{text:"CR:"}),this.crInput=t.createEl("input",{type:"text",placeholder:"e.g., 5, 1/4"});let n=s.createDiv();n.createEl("label",{text:"XP:"}),this.xpInput=n.createEl("input",{type:"number",placeholder:"e.g., 1800"}),this.crInput.addEventListener("input",()=>{let a=this.crInput.value.trim(),i=this.plugin.getCRtoXP(a);i!==null&&(this.xpInput.value=String(i))});let r=e.createDiv({cls:"encounter-button-container"});r.createEl("button",{text:"Submit",cls:"mod-cta"}).addEventListener("click",()=>{let a=this.crInput.value.trim(),i=parseInt(this.xpInput.value,10);if(!a){new p.Notice("Enter CR");return}if(isNaN(i)||i<0){new p.Notice("Enter valid XP >= 0");return}this.onSubmit({cr:a,xp:i,source:"Manual"}),this.close()}),r.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{var a;(a=this.onCancel)==null||a.call(this),this.close()}),setTimeout(()=>this.crInput.focus(),50)}onClose(){this.contentEl.empty()}},_=class extends p.PluginSettingTab{constructor(e,s){super(e,s);this.plugin=s}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Encounter Builder Settings"}),e.createEl("p",{text:"Configure monster stat block locations."}),new p.Setting(e).setName("Primary Location").setDesc("e.g., 2024_z_compendium/bestiary").addText(s=>s.setPlaceholder("path/to/monsters").setValue(this.plugin.settings.monsterLocation1).onChange(async t=>{this.plugin.settings.monsterLocation1=t.trim(),await this.plugin.saveSettings()})),new p.Setting(e).setName("Secondary Location").setDesc("e.g., z_compendium/bestiary").addText(s=>s.setPlaceholder("path/to/monsters").setValue(this.plugin.settings.monsterLocation2).onChange(async t=>{this.plugin.settings.monsterLocation2=t.trim(),await this.plugin.saveSettings()})),new p.Setting(e).setName("Custom Location").setDesc("e.g., creatures/homebrew").addText(s=>s.setPlaceholder("path/to/monsters").setValue(this.plugin.settings.monsterLocation3).onChange(async t=>{this.plugin.settings.monsterLocation3=t.trim(),await this.plugin.saveSettings()})),new p.Setting(e).setName("Search All Vault").setDesc("Search vault if not found in locations").addToggle(s=>s.setValue(this.plugin.settings.searchAllVault).onChange(async t=>{this.plugin.settings.searchAllVault=t,await this.plugin.saveSettings()}))}},O=class extends p.Plugin{constructor(){super(...arguments);this.DEFAULT_SETTINGS={monsterLocation1:"2024_z_compendium/bestiary",monsterLocation2:"z_compendium/bestiary",monsterLocation3:"",searchAllVault:!0};this.lastPartySize=4;this.lastPartyLevel=3;this.CR_TO_XP_2024={0:10,"1/8":25,"1/4":50,"1/2":100,1:200,2:450,3:700,4:1100,5:1800,6:2300,7:2900,8:3900,9:5e3,10:5900,11:7200,12:8400,13:1e4,14:11500,15:13e3,16:15e3,17:18e3,18:2e4,19:22e3,20:25e3,21:33e3,22:41e3,23:5e4,24:62e3,25:75e3,26:9e4,27:105e3,28:12e4,29:135e3,30:155e3}}async onload(){console.log("Loading Encounter Builder Plugin"),await this.loadSettings(),this.addSettingTab(new _(this.app,this)),this.addCommand({id:"create-encounter-table",name:"Create Encounter Table",editorCallback:(e,s)=>{console.log("--- EB: Create NEW Encounter command triggered ---"),new $(this.app,this,!1).open()}}),this.registerMarkdownCodeBlockProcessor("encounter",(e,s,t)=>{var n;try{let r=s.createDiv({cls:"encounter-table-container"}),a=r.createEl("table",{cls:"encounter-table"}),i=e.trim().split(`
`),c=!1,o=null,u=null;for(let l=0;l<i.length;l++){let m=i[l].trim();if(!m||m.indexOf("|")===-1||m.replace(/[\|\-\s]/g,"").length===0){m.includes("---")&&(c=!0);continue}let h=!c&&(m.toLowerCase().includes("qty")||m.toLowerCase().includes("creature")),g=m.toLowerCase().includes("total");if(m.includes(":---")){c=!0;continue}let f=a.insertRow();g&&f.addClass("encounter-total-row");let y=m.split("|");for(let v=0;v<y.length;v++){let x=y[v].trim();if((v===0||v===y.length-1)&&x==="")continue;let T=h&&!g,w=f.createEl(T?"th":"td");p.MarkdownRenderer.renderMarkdown(x,w,t.sourcePath,this),w.children.length===1&&((n=w.firstElementChild)==null?void 0:n.tagName)==="P"&&(w.innerHTML=w.firstElementChild.innerHTML)}if(h&&!g)u||(u=a.createTHead()),u.appendChild(f),c=!0;else if(!g)o||(o=a.createTBody()),o.appendChild(f);else{let v=a.tFoot;v||(v=a.createTFoot()),v.appendChild(f),Array.from(f.cells).forEach(x=>x.style.fontWeight="bold")}}let d=this.addDifficultyCalculator(r,e);if(d){let l=d.querySelector(".encounter-controls");if(l){let m=l.createEl("button",{text:"Edit Encounter"});m.addClass("encounter-edit-btn"),m.addEventListener("click",()=>{console.log("--- EB: Edit button clicked ---");try{let h=J(e),g=t.getSectionInfo(s),f=t.sourcePath;if(!(h!=null&&h.creatures))throw new Error("Could not parse creatures.");new $(this.app,this,!0,h.creatures,g,f).open()}catch(h){console.error("EB: Error parsing source for editing",h),new p.Notice("Could not parse encounter data for editing.")}})}else console.warn("EB: Could not find .encounter-controls to add Edit button.")}}catch(r){console.error("EB Error rendering code block:",r),s.createDiv({cls:"encounter-error",text:"Error rendering encounter: "+(r instanceof Error?r.message:String(r))})}}),console.log("--- Encounter Builder: Fully Loaded ---")}onunload(){console.log("Unloading Encounter Builder Plugin")}async loadSettings(){this.settings=Object.assign({},this.DEFAULT_SETTINGS,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}getCRtoXP(e){var s;return(s=this.CR_TO_XP_2024[e])!=null?s:null}addDifficultyCalculator(e,s){let t=e.createDiv({cls:"encounter-difficulty-wrapper"});try{let n=J(s),r=t.createDiv({cls:"encounter-party-form"});r.createEl("label",{text:"Party Size:"});let a=r.createEl("input",{type:"number",value:String(this.lastPartySize)});a.min="1",a.addClass("encounter-party-size"),r.createEl("label",{text:"Avg Level:"});let i=r.createEl("input",{type:"number",value:String(this.lastPartyLevel)});i.min="1",i.max="20",i.addClass("encounter-party-level");let o=t.createDiv({cls:"encounter-controls",attr:{style:"display: flex; gap: 10px; margin-top: 5px; align-items: center;"}}).createEl("button",{text:"Calculate Difficulty"});o.addClass("encounter-calculate-btn");let u=t.createDiv({cls:"encounter-difficulty-results"});return u.style.display="none",o.addEventListener("click",()=>{let d=parseInt(a.value,10),l=parseInt(i.value,10);if(this.lastPartySize=d&&d>=1?d:this.lastPartySize,this.lastPartyLevel=l&&l>=1&&l<=20?l:this.lastPartyLevel,a.value=String(this.lastPartySize),i.value=String(this.lastPartyLevel),this.lastPartySize<1||this.lastPartyLevel<1||this.lastPartyLevel>20){new p.Notice("Enter valid party size/level."),u.style.display="none";return}this.calculateDifficulty(u,n,this.lastPartySize,this.lastPartyLevel),u.style.display="block"}),t}catch(n){return console.error("EB: Error adding difficulty calculator",n),t.createDiv({cls:"encounter-error",text:"Error initializing calculator."}),null}}calculateDifficulty(e,s,t,n){e.empty();let{creatures:r,totalXP:a,totalCR:i,highestCR:c}=s,o={1:{low:50,moderate:75,high:100},2:{low:100,moderate:150,high:200},3:{low:150,moderate:225,high:400},4:{low:250,moderate:375,high:500},5:{low:500,moderate:750,high:1100},6:{low:600,moderate:1e3,high:1400},7:{low:750,moderate:1300,high:1700},8:{low:1e3,moderate:1700,high:2100},9:{low:1300,moderate:2e3,high:2600},10:{low:1600,moderate:2300,high:3100},11:{low:1900,moderate:2900,high:4100},12:{low:2200,moderate:3700,high:4700},13:{low:2600,moderate:4200,high:5400},14:{low:2900,moderate:4900,high:6200},15:{low:3300,moderate:5400,high:7800},16:{low:3800,moderate:6100,high:9800},17:{low:4500,moderate:7200,high:11700},18:{low:5e3,moderate:8700,high:14200},19:{low:5500,moderate:10700,high:17200},20:{low:6400,moderate:13200,high:22e3}};if(n<1||n>20||!o[n]){e.createDiv({cls:"encounter-error",text:"Party level must be 1-20."});return}let u=o[n],d=u.low*t,l=u.moderate*t,m=u.high*t,h,g;a>m?(h="Out of Bounds",g="encounter-deadly"):a>l?(h="High",g="encounter-hard"):a>d?(h="Moderate",g="encounter-medium"):a>=u.low*t?(h="Low",g="encounter-easy"):(h="Below Low",g="encounter-trivial");let f=e.createDiv({cls:"encounter-header-container"});f.createEl("h4",{text:`Difficulty for ${t} level ${n} characters (2024 Rules)`});let y=e.createDiv({cls:"encounter-content-container"});y.dataset.visible="true";let v=f.createEl("button",{text:"Hide Details",cls:"encounter-toggle-details-button"});v.onclick=()=>{let b=y.dataset.visible==="true";y.dataset.visible=b?"false":"true",v.textContent=b?"Show Details":"Hide Details"};let x=y.createDiv({cls:"encounter-dmg-section"});x.createDiv({cls:"encounter-multiplier-info"}).createEl("p",{text:`Encounter Total XP: ${a.toLocaleString()}`});let T=x.createEl("table",{cls:"encounter-threshold-table"}),w=T.createTHead().insertRow();["Difficulty","Party Budget (Total)","Encounter XP (Total)"].forEach(b=>w.createEl("th",{text:b}));let z=T.createTBody();[{name:"Low",value:d},{name:"Moderate",value:l},{name:"High",value:m}].forEach(b=>{let N=z.insertRow();(b.name==="Low"&&h==="Low"||b.name==="Moderate"&&h==="Moderate"||b.name==="High"&&h==="High")&&N.addClass("encounter-highlighted-row"),N.insertCell().textContent=b.name,N.insertCell().textContent=`Up to ${b.value.toLocaleString()}`;let A=N.insertCell();A.textContent=a.toLocaleString(),b.name===h&&(A.addClass(g),A.style.fontWeight="bold")});let P=z.insertRow();h==="Out of Bounds"&&P.addClass("encounter-highlighted-row"),P.insertCell().textContent="Out of Bounds",P.insertCell().textContent=`> ${m.toLocaleString()}`;let H=P.insertCell();H.textContent=a.toLocaleString(),h==="Out of Bounds"&&(H.addClass(g),H.style.fontWeight="bold");let W=x.createDiv({cls:"encounter-summary"});W.textContent="DMG 2024 Rating: ";let V=W.createEl("span",{text:h});V.addClass(g),V.style.fontWeight="bold";let U=y.createDiv({cls:"encounter-lazy-section",attr:{style:"margin-top: 15px; border-top: 1px solid var(--background-modifier-border); padding-top: 15px;"}});U.createEl("h5",{text:"Lazy DM Benchmark (CR Based)"});let S=U.createDiv({cls:"encounter-lazy-info"}),K=t*n,G=n>=5?2:4,L=K/G,Q=n>=5?1.5:1,I=n*Q;S.createEl("p",{text:`Party: ${t} Lvl ${n} (${K} total)`}),S.createEl("p",{text:`Threshold > CR ${L.toFixed(2)} (1/${G} levels)`});let Z=S.createEl("p"),tt=`Sum CRs: ${i.toFixed(2)}`,k="encounter-easy";i>L?k="encounter-deadly":i>L*.75?k="encounter-hard":i>L*.5&&(k="encounter-medium"),Z.createEl("span",{text:tt,cls:k,attr:{style:"font-weight:bold;"}}),S.createEl("p",{text:`Single > CR ${I.toFixed(2)} (${Q}x level)`});let et=S.createEl("p"),nt=`Highest CR: ${c.toFixed(2)}`,D="encounter-easy";c>I?D="encounter-deadly":c>I*.75?D="encounter-hard":c>I*.5&&(D="encounter-medium"),et.createEl("span",{text:nt,cls:D,attr:{style:"font-weight:bold;"}});let B=S.createEl("p");B.addClass("encounter-lazy-rating");let R="Easy",M="encounter-easy";i>L||c>I?(R="Potentially Deadly",M="encounter-deadly"):i>L*.75||c>I*.75?(R="Hard",M="encounter-hard"):(i>L*.5||c>I*.5)&&(R="Medium",M="encounter-medium"),B.textContent="Lazy DM Rating: ";let Y=B.createEl("span",{text:R});Y.addClass(M),Y.style.fontWeight="bold",B.style.marginTop="0.5em"}async lookupCreatureStats(e){if(!e)return null;let s=e.toLowerCase().trim();try{let t=this.app.vault.getMarkdownFiles(),n=[],r=this.settings,i=[r.monsterLocation1,r.monsterLocation2,r.monsterLocation3].filter(o=>o&&o.trim()!=="").map(o=>o.endsWith("/")?o:o+"/");if(i.length>0&&(n=t.filter(o=>o.basename.toLowerCase()===s&&i.some(u=>o.path.startsWith(u)))),n.length===0&&i.length>0)for(let o of i){let u=t.filter(d=>d.basename.toLowerCase().includes(s)&&d.path.startsWith(o));if(u.length>0){n=u;break}}if(n.length===0&&r.searchAllVault){n=t.filter(u=>u.basename.toLowerCase().includes(s));let o=n.filter(u=>u.basename.toLowerCase()===s);o.length>0&&(n=o)}if(n.length===0)return console.log(`EB: Not found: ${e}`),new p.Notice(`Not found: ${e}`),null;let c=null;if(n.length>1){let o=["**AC**","**HP**","**CR**","{{stats","{{vitals","Challenge","hit points"],u=n.map(async l=>{try{let m=await this.app.vault.cachedRead(l);return o.some(h=>m.includes(h))?l:null}catch(m){return null}}),d=(await Promise.all(u)).filter(l=>l!==null);if(d.length===1)c=d[0];else{let l=d.length>1?d:n;return new Promise(m=>{let h=!1,g=new X(this.app,this,l,async y=>{h||(h=!0,m(await this.processCreatureFile(y)))}),f=g.onClose.bind(g);g.onClose=()=>{f(),h||(h=!0,console.log("EB: Select modal cancelled."),m(null))},g.open()})}}else c=n[0];return c?await this.processCreatureFile(c):(console.log(`EB: No file determined for ${e}`),null)}catch(t){return console.error(`EB Error lookup ${e}:`,t),new p.Notice(`Error lookup: ${e}`),null}}async processCreatureFile(e){try{let s=await this.app.vault.cachedRead(e),t=this.parseCreatureStats(s,e.basename,e.path),n="Custom";return e.path.includes("2024_z_compendium")?n="2024":e.path.includes("z_compendium")&&(n="Classic"),t?(t.source=n,t):new Promise(r=>{let a=!1,i=new q(this.app,this,e.basename,o=>{a||(a=!0,r(o))}),c=i.onClose.bind(i);i.onClose=()=>{c(),a||(a=!0,console.log("EB: Manual modal cancelled."),r(null))},i.open()})}catch(s){return console.error(`EB Error process ${e.path}:`,s),new p.Notice(`Error process: ${e.basename}`),null}}parseCreatureStats(e,s="Unknown",t=null){var n,r;try{let a=/(?:(?:\*\*|__)Challenge(?:\*\*|__)\s*:?|Challenge\s+Rating\s*:?)\s*([0-9\/]+)\s*\(([0-9,]+\s*XP)\)/i,i=e.match(a);if(i!=null&&i[1]&&i[2]){let d=i[1].trim(),l=parseInt(i[2].replace(/,/g,"").replace(/\s*XP/i,"").trim(),10);if(d&&!isNaN(l))return{cr:d,xp:l}}let c=/\*\*CR\*\*[\s:]*::?[\s:]*([0-9\/]+)/i;if(i=e.match(c),i!=null&&i[1]){let d=i[1].trim(),l=this.getCRtoXP(d);if(l!==null)return{cr:d,xp:l}}let o=/\*\*CR\*\*.*?([0-9\/]+)/i;if(i=e.match(o),i!=null&&i[1]){let d=i[1].trim(),l=this.getCRtoXP(d);if(l!==null)return{cr:d,xp:l}}if(t){let d=this.app.vault.getAbstractFileByPath(t);if(d instanceof p.TFile){let l=this.app.metadataCache.getFileCache(d);if(l!=null&&l.frontmatter){let m=l.frontmatter,h=m.cr!==void 0?String(m.cr).trim():null,g=null;if(m.xp!==void 0){let f=parseInt(String(m.xp).replace(/,/g,""),10);isNaN(f)||(g=f)}if(h&&(g===null&&(g=this.getCRtoXP(h)),g!==null))return{cr:h,xp:g}}}}let u=/^---\s*([\s\S]*?)\s*---/;if(i=e.match(u),i!=null&&i[1]){let d=i[1],l=d.match(/^(?:cr|challenge):\s*['"]?([0-9\/]+)['"]?/im),m=d.match(/^xp:\s*['"]?([0-9,]+)['"]?/im),h=(r=(n=l==null?void 0:l[1])==null?void 0:n.trim())!=null?r:null,g=m!=null&&m[1]?parseInt(m[1].replace(/,/g,""),10):null;if(h&&((g===null||isNaN(g))&&(g=this.getCRtoXP(h)),g!==null&&!isNaN(g)))return{cr:h,xp:g}}return e.includes("{{monster")&&(e.includes("spell's level")||e.includes("upcast"))?{cr:"Varies",xp:0}:(console.warn(`EB: Could not parse CR/XP for ${s}. Path: ${t!=null?t:"N/A"}`),null)}catch(a){return console.error(`EB: Error parsing stats for ${s}:`,a),null}}},ht=O;
