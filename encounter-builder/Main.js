"use strict";var q=Object.defineProperty;var ot=Object.getOwnPropertyDescriptor;var rt=Object.getOwnPropertyNames;var it=Object.prototype.hasOwnProperty;var at=(b,C)=>{for(var e in C)q(b,e,{get:C[e],enumerable:!0})},lt=(b,C,e,o)=>{if(C&&typeof C=="object"||typeof C=="function")for(let t of rt(C))!it.call(b,t)&&t!==e&&q(b,t,{get:()=>C[t],enumerable:!(o=ot(C,t))||o.enumerable});return b};var ct=b=>lt(q({},"__esModule",{value:!0}),b);var mt={};at(mt,{default:()=>pt});module.exports=ct(mt);var p=require("obsidian"),ut=0,dt=1,ht=2,Z=3;function X(b){let C=b.trim().split(`
`),e=[],o=!1,t=0,n=0,r=0;for(let s of C){let l=s.trim();if(!l||l.indexOf("|")===-1||l.replace(/[\|\-\s]/g,"").length===0||l.includes(":---")){l.includes("---")&&(o=!0);continue}if(!o&&(l.toLowerCase().includes("creature")||l.toLowerCase().includes("cr"))){o=!0;continue}if(l.toLowerCase().includes("total"))continue;let i=l.split("|").map(u=>u.trim());if(i[0]===""&&i.shift(),i[i.length-1]===""&&i.pop(),i.length>=Z+1){let u=parseInt(i[ut],10)||1,d=i[dt],c=i[ht],g=i[Z],m=0;if(c)if(c.includes("/")){let f=c.split("/");f.length===2&&!isNaN(parseFloat(f[0]))&&!isNaN(parseFloat(f[1]))&&parseFloat(f[1])!==0?m=parseFloat(f[0])/parseFloat(f[1]):(console.warn(`EB: Bad fraction CR: ${c}`),m=0)}else{let f=parseFloat(c);isNaN(f)?(typeof c=="string"&&c.toLowerCase()!=="varies"&&console.warn(`EB: Bad number CR: ${c}`),m=0):m=f}else console.warn(`EB: Missing CR: ${l}`),m=0;let h=parseInt(g.replace(/,/g,""),10)||0;u>0&&d&&(e.push({quantity:u,name:d,cr:c,crText:c,xp:h}),t+=u*h,r+=u*m,n=Math.max(n,m))}else console.warn(`EB: Skipping row, bad columns: ${l}`)}let a=null;for(let s of C){let l=s.trim();if(l.toLowerCase().includes("total")){let i=l.split("|").map(u=>u.trim());i[0]===""&&i.shift(),i[i.length-1]===""&&i.pop();for(let u=i.length-1;u>=0;u--){let d=i[u];if(d&&d.length>0){let c=d.match(/(\d[\d,]*)/);if(c&&c[1]){let g=parseInt(c[1].replace(/,/g,""),10);if(!isNaN(g)){a=g;break}}}}if(a!==null)break}}return{creatures:e,totalXP:a!==null?a:t,totalCR:r,highestCR:n}}var N=class extends p.Modal{constructor(e,o,t=!1,n,r,a){super(e);this.plugin=o,this.isEditing=t,this.creatures=n?JSON.parse(JSON.stringify(n)):[],this.sectionInfo=r!=null?r:null,this.sourcePath=a!=null?a:null,this.monsterFiles=[]}onOpen(){this.contentEl.empty(),this.contentEl.createEl("h2",{text:this.isEditing?"Edit Encounter":"Create Encounter"});let e=this.contentEl.createDiv({cls:"encounter-form"}),o=e.createDiv();o.createEl("label",{text:"Quantity:"}),this.quantityInput=o.createEl("input",{type:"number",value:"1"}),this.quantityInput.min="1";let t=e.createDiv();t.createEl("label",{text:"Creature:"}),this.nameContainer=t.createEl("div",{cls:"encounter-creature-input-container"}),this.nameInput=this.nameContainer.createEl("input",{type:"text",placeholder:"Enter creature name..."});let n=this.nameContainer.createEl("button",{text:"Lookup CR/XP"});n.addClass("mod-cta"),n.addEventListener("click",()=>this.lookupCreature());let r=e.createDiv();r.createEl("label",{text:"CR:"}),this.crInput=r.createEl("input",{type:"text",placeholder:"Lookup or enter manually"});let a=e.createDiv();a.createEl("label",{text:"XP:"}),this.xpInput=a.createEl("input",{type:"number",placeholder:"Lookup or enter manually"}),this.xpInput.min="0",e.createEl("button",{text:"Add Creature to List"}).addEventListener("click",()=>this.addCreature()),this.listEl=this.contentEl.createDiv({cls:"encounter-creature-list"}),this.renderCreatureList();let l=this.contentEl.createDiv({cls:"encounter-button-container"}),i=l.createEl("button",{text:this.isEditing?"Save Changes":"Create Encounter Table"});i.addClass("mod-cta"),i.addEventListener("click",()=>this.createEncounter()),l.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),l.createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.close()),this.setupAutocomplete(),this.addQuickAddSection(),this.setupKeyboardNavigation(),setTimeout(()=>this.nameInput.focus(),50)}setupKeyboardNavigation(){this.nameInput.addEventListener("keydown",async e=>{var o,t;if(e.key==="Enter"){let n=(o=this.suggestionContainer)==null?void 0:o.querySelector(".selected");if(((t=this.suggestionContainer)==null?void 0:t.style.display)!=="none"&&n)return;e.preventDefault(),await this.lookupCreature(),(this.crInput.value||this.xpInput.value)&&this.quantityInput.focus()}}),this.quantityInput.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),this.nameInput.focus())}),this.crInput.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),this.xpInput.focus())}),this.xpInput.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),this.addOrUpdateCreature())})}setupAutocomplete(){this.suggestionContainer=this.nameContainer.createDiv({cls:"encounter-suggestions"}),this.suggestionContainer.style.display="none";let o=[this.plugin.settings.monsterLocation1,this.plugin.settings.monsterLocation2,this.plugin.settings.monsterLocation3].filter(t=>t&&t.trim()!=="").map(t=>t.endsWith("/")?t:t+"/");this.monsterFiles=this.app.vault.getMarkdownFiles().filter(t=>o.length===0?t.path.includes("/bestiary/")&&(t.path.includes("z_compendium/")||t.path.includes("2024_z_compendium/")):o.some(n=>t.path.startsWith(n))),this.debouncedSearch=this.debounce(()=>{let t=this.nameInput.value.trim().toLowerCase();if(t.length<2){this.suggestionContainer.style.display="none";return}let n=this.monsterFiles.filter(r=>r.basename.toLowerCase().includes(t)).sort((r,a)=>{let s=r.basename.toLowerCase()===t,l=a.basename.toLowerCase()===t,i=r.path.includes("2024"),u=a.path.includes("2024");return s!==l?s?-1:1:i!==u?i?-1:1:r.basename.toLowerCase().localeCompare(a.basename.toLowerCase())}).slice(0,7);if(this.suggestionContainer.empty(),n.length===0){this.suggestionContainer.style.display="none";return}n.forEach(r=>{let a=r.path.includes("2024")?" (2024)":"";this.suggestionContainer.createDiv({cls:"encounter-suggestion-item",text:r.basename+a}).addEventListener("click",()=>{this.nameInput.value=r.basename,this.suggestionContainer.style.display="none",this.lookupCreature()})}),this.suggestionContainer.style.display="block"},300),this.nameInput.addEventListener("input",()=>{this.debouncedSearch()}),document.addEventListener("click",t=>{this.nameContainer&&!this.nameContainer.contains(t.target)&&this.suggestionContainer&&(this.suggestionContainer.style.display="none")},!0),this.nameInput.addEventListener("keydown",t=>{var l,i,u,d;if(this.suggestionContainer.style.display==="none")return;let n=this.suggestionContainer.querySelectorAll(".encounter-suggestion-item");if(n.length===0)return;let r=this.suggestionContainer.querySelector(".selected"),a=r?Array.from(n).indexOf(r):-1,s=a;switch(t.key){case"ArrowDown":t.preventDefault(),s=Math.min(a+1,n.length-1);break;case"ArrowUp":t.preventDefault(),s=Math.max(a-1,0);break;case"Enter":r&&(t.preventDefault(),this.nameInput.value=(i=(l=r.textContent)==null?void 0:l.replace(" (2024)","").trim())!=null?i:"",this.suggestionContainer.style.display="none",this.lookupCreature());return;case"Escape":t.preventDefault(),this.suggestionContainer.style.display="none";return}s!==a&&(r&&r.removeClass("selected"),(u=n[s])==null||u.addClass("selected"),(d=n[s])==null||d.scrollIntoView({block:"nearest"}))})}debounce(e,o){let t=null;return()=>{t!==null&&clearTimeout(t),t=window.setTimeout(()=>{e(),t=null},o)}}async lookupCreature(){let e=this.nameInput.value.trim();if(!e){new p.Notice("Please enter a creature name.");return}this.crInput.value="",this.xpInput.value="";let o=new p.Notice(`Looking up '${e}'...`,0);try{let t=await this.plugin.lookupCreatureStats(e);o.hide(),(t==null?void 0:t.cr)!==void 0&&t.xp!==void 0?(this.crInput.value=String(t.cr),this.xpInput.value=String(t.xp),new p.Notice(`Found: ${e} (CR ${t.cr}, ${t.xp} XP)`)):(this.nameInput.focus(),this.nameInput.select())}catch(t){o.hide(),console.error("EB Lookup Error:",t),new p.Notice(`Error looking up '${e}'.`),this.nameInput.focus(),this.nameInput.select()}}addOrUpdateCreature(){this.editingIndex!==void 0?this.updateCreature():this.addCreature()}addCreature(){let e=parseInt(this.quantityInput.value,10)||1,o=this.nameInput.value.trim(),t=this.crInput.value.trim(),n=this.xpInput.value.trim(),r=parseInt(n,10);if(!o){new p.Notice("Enter creature name."),this.nameInput.focus();return}if(!t){new p.Notice("Enter CR."),this.crInput.focus();return}if(!n||isNaN(r)||r<0){new p.Notice("Enter valid XP >= 0."),this.xpInput.focus();return}this.creatures.push({quantity:e,name:o,cr:t,crText:t,xp:r}),this.renderCreatureList(),this.resetForm(),this.nameInput.focus()}renderCreatureList(){if(this.listEl.empty(),this.creatures.length===0){this.listEl.createEl("p",{text:"No creatures added yet."});return}let e=this.listEl.createEl("table",{cls:"encounter-modal-table"}),t=e.createTHead().insertRow();["Qty","Creature","CR","XP","Total XP","Actions"].forEach(i=>t.createEl("th",{text:i}));let n=e.createTBody(),r=0;this.creatures.forEach((i,u)=>{let d=n.insertRow(),c=i.quantity*i.xp;r+=c,d.insertCell().textContent=i.quantity.toString(),d.insertCell().textContent=i.name,d.insertCell().textContent=String(i.cr),d.insertCell().textContent=i.xp.toLocaleString(),d.insertCell().textContent=c.toLocaleString();let m=d.insertCell().createDiv({cls:"encounter-actions"});m.createEl("button",{text:"Edit"}).addEventListener("click",()=>this.editCreature(u)),m.createEl("button",{text:"Remove",cls:"mod-warning"}).addEventListener("click",()=>{let h=this.editingIndex===u;this.creatures.splice(u,1),this.renderCreatureList(),h&&this.resetFormAndButton()})});let s=e.createTFoot().insertRow();s.addClass("encounter-modal-total-row");let l=s.insertCell();l.textContent="TOTAL",l.colSpan=4,s.insertCell().textContent=r.toLocaleString(),s.insertCell()}editCreature(e){let o=this.creatures[e];if(!o)return;this.editingIndex=e,this.quantityInput.value=String(o.quantity),this.nameInput.value=o.name,this.crInput.value=String(o.cr),this.xpInput.value=String(o.xp);let t=this.contentEl.querySelector(".encounter-form > button:not(.mod-cta):not(.mod-warning)");if(t){t.textContent="Update Creature";let n=t.cloneNode(!0);t.replaceWith(n),n.addEventListener("click",()=>this.updateCreature())}this.quantityInput.focus(),this.quantityInput.select()}addQuickAddSection(){let e=this.contentEl.createDiv({cls:"encounter-quick-add"});e.createEl("h3",{text:"Quick Add Common Monsters"});let o=[{name:"Zombie",cr:"1/4",xp:50,source:"2024"},{name:"Skeleton",cr:"1/4",xp:50,source:"2024"},{name:"Goblin",cr:"1/4",xp:50,source:"2024"},{name:"Kobold",cr:"1/8",xp:25,source:"2024"},{name:"Orc",cr:"1/2",xp:100,source:"2024"},{name:"Bandit",cr:"1/8",xp:25,source:"2024"},{name:"Wolf",cr:"1/4",xp:50,source:"2024"},{name:"Giant Rat",cr:"1/8",xp:25,source:"2024"}].map(n=>{var r;return{...n,name:(r=n.name)!=null?r:"Unknown"}}),t=e.createDiv({cls:"encounter-quick-add-buttons"});o.forEach(n=>{let r=t.createEl("button",{text:`${n.name} (CR ${n.cr})`,cls:"encounter-quick-add-btn"});n.source==="2024"&&r.addClass("encounter-source-2024"),r.addEventListener("click",()=>{var a;this.nameInput.value=(a=n.name)!=null?a:"",this.crInput.value=String(n.cr),this.xpInput.value=String(n.xp),this.editingIndex!==void 0&&this.resetFormAndButton(),this.quantityInput.focus(),this.quantityInput.select()})})}updateCreature(){if(this.editingIndex===void 0)return;let e=parseInt(this.quantityInput.value,10)||1,o=this.nameInput.value.trim(),t=this.crInput.value.trim(),n=this.xpInput.value.trim(),r=parseInt(n,10);if(!o){new p.Notice("Enter creature name."),this.nameInput.focus();return}if(!t){new p.Notice("Enter CR."),this.crInput.focus();return}if(!n||isNaN(r)||r<0){new p.Notice("Enter valid XP >= 0."),this.xpInput.focus();return}this.creatures[this.editingIndex]={quantity:e,name:o,cr:t,crText:t,xp:r},this.renderCreatureList(),this.resetFormAndButton(),this.nameInput.focus()}resetForm(){this.quantityInput.value="1",this.nameInput.value="",this.crInput.value="",this.xpInput.value=""}resetFormAndButton(){this.resetForm(),this.editingIndex=void 0;let e=this.contentEl.querySelector(".encounter-form > button:not(.mod-cta):not(.mod-warning)");if(e){e.textContent="Add Creature to List";let o=e.cloneNode(!0);e.replaceWith(o),o.addEventListener("click",()=>this.addCreature())}}createEncounter(){var a;if(this.creatures.length===0){new p.Notice("Add at least one creature.");return}let e=`| Qty | Creature | CR | XP | Total XP |
`;e+=`|:----|:---------|:---|---:|---------:|
`;let o=0;this.creatures.forEach(s=>{let l=s.quantity*s.xp;o+=l;let i=s.name.trim();!i.startsWith("[[")&&!i.endsWith("]]")&&(i=`[[${i}]]`),e+=`| ${s.quantity} | ${i} | ${s.cr} | ${s.xp.toLocaleString()} | ${l.toLocaleString()} |
`}),e+=`| **Total** | | | | **${o.toLocaleString()}** |
`;let t="```encounter\n"+e+"```\n",n=this.app.workspace.activeLeaf;if(!n||!(n.view instanceof p.MarkdownView)){new p.Notice("No active Markdown editor.");return}let r=n.view.editor;if(this.isEditing&&this.sectionInfo&&this.sourcePath===((a=n.view.file)==null?void 0:a.path)){console.log(`Attempting to replace range: Line ${this.sectionInfo.lineStart} to ${this.sectionInfo.lineEnd}`);try{r.replaceRange(t,{line:this.sectionInfo.lineStart,ch:0},{line:this.sectionInfo.lineEnd,ch:r.getLine(this.sectionInfo.lineEnd).length}),new p.Notice("Encounter block updated successfully.")}catch(s){console.error("EB: Error replacing range:",s),new p.Notice("Error updating block. Inserting at cursor instead. Please delete original."),r.replaceSelection(t)}}else r.replaceSelection(t),this.isEditing&&new p.Notice("Original block context lost or file changed. Updated encounter inserted at cursor. Please delete the original.");this.close()}onClose(){this.contentEl.empty()}},_=class extends p.Modal{constructor(e,o,t,n){super(e);this.plugin=o,this.files=t,this.onSelect=n}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Multiple Monsters Found"}),e.createEl("p",{text:"Multiple files match. Select the correct one:"});let o=e.createDiv({cls:"encounter-file-list"});this.files.forEach(t=>{let n=o.createDiv({cls:"encounter-file-item"}),r=n.createDiv();r.createEl("div",{cls:"encounter-file-name",text:t.basename}),r.createEl("div",{cls:"encounter-file-path",text:t.path}),n.createEl("button",{text:"Select",cls:"mod-cta"}).addEventListener("click",()=>{this.onSelect(t),this.close()})}),e.createDiv({cls:"encounter-button-container"}).createEl("button",{text:"Cancel"}).addEventListener("click",()=>{var t;(t=this.onCancel)==null||t.call(this),this.close()})}onClose(){this.contentEl.empty()}},O=class extends p.Modal{constructor(e,o,t,n){super(e);this.plugin=o,this.creatureName=t,this.onSubmit=n}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Enter Monster Stats"}),e.createEl("p",{text:`Could not parse CR/XP for "${this.creatureName}". Enter manually:`});let o=e.createDiv({cls:"encounter-manual-form"}),t=o.createDiv();t.createEl("label",{text:"CR:"}),this.crInput=t.createEl("input",{type:"text",placeholder:"e.g., 5, 1/4"});let n=o.createDiv();n.createEl("label",{text:"XP:"}),this.xpInput=n.createEl("input",{type:"number",placeholder:"e.g., 1800"}),this.crInput.addEventListener("input",()=>{let a=this.crInput.value.trim(),s=this.plugin.getCRtoXP(a);s!==null&&(this.xpInput.value=String(s))});let r=e.createDiv({cls:"encounter-button-container"});r.createEl("button",{text:"Submit",cls:"mod-cta"}).addEventListener("click",()=>{let a=this.crInput.value.trim(),s=parseInt(this.xpInput.value,10);if(!a){new p.Notice("Enter CR");return}if(isNaN(s)||s<0){new p.Notice("Enter valid XP >= 0");return}this.onSubmit({cr:a,xp:s,source:"Manual"}),this.close()}),r.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{var a;(a=this.onCancel)==null||a.call(this),this.close()}),setTimeout(()=>this.crInput.focus(),50)}onClose(){this.contentEl.empty()}},z=class extends p.PluginSettingTab{constructor(e,o){super(e,o);this.plugin=o}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Encounter Builder Settings"}),e.createEl("p",{text:"Configure monster stat block locations."}),new p.Setting(e).setName("Primary Location").setDesc("e.g., 2024_z_compendium/bestiary").addText(o=>o.setPlaceholder("path/to/monsters").setValue(this.plugin.settings.monsterLocation1).onChange(async t=>{this.plugin.settings.monsterLocation1=t.trim(),await this.plugin.saveSettings()})),new p.Setting(e).setName("Secondary Location").setDesc("e.g., z_compendium/bestiary").addText(o=>o.setPlaceholder("path/to/monsters").setValue(this.plugin.settings.monsterLocation2).onChange(async t=>{this.plugin.settings.monsterLocation2=t.trim(),await this.plugin.saveSettings()})),new p.Setting(e).setName("Custom Location").setDesc("e.g., creatures/homebrew").addText(o=>o.setPlaceholder("path/to/monsters").setValue(this.plugin.settings.monsterLocation3).onChange(async t=>{this.plugin.settings.monsterLocation3=t.trim(),await this.plugin.saveSettings()})),new p.Setting(e).setName("Search All Vault").setDesc("Search vault if not found in locations").addToggle(o=>o.setValue(this.plugin.settings.searchAllVault).onChange(async t=>{this.plugin.settings.searchAllVault=t,await this.plugin.saveSettings()}))}},W=class extends p.Plugin{constructor(){super(...arguments);this.DEFAULT_SETTINGS={monsterLocation1:"2024_z_compendium/bestiary",monsterLocation2:"z_compendium/bestiary",monsterLocation3:"",searchAllVault:!0};this.lastPartySize=4;this.lastPartyLevel=3;this.CR_TO_XP_2024={0:10,"1/8":25,"1/4":50,"1/2":100,1:200,2:450,3:700,4:1100,5:1800,6:2300,7:2900,8:3900,9:5e3,10:5900,11:7200,12:8400,13:1e4,14:11500,15:13e3,16:15e3,17:18e3,18:2e4,19:22e3,20:25e3,21:33e3,22:41e3,23:5e4,24:62e3,25:75e3,26:9e4,27:105e3,28:12e4,29:135e3,30:155e3}}async onload(){console.log("Loading Encounter Builder Plugin"),await this.loadSettings(),this.addSettingTab(new z(this.app,this)),this.addCommand({id:"create-encounter-table",name:"Create Encounter Table",editorCallback:(e,o)=>{console.log("--- EB: Create NEW Encounter command triggered ---"),new N(this.app,this,!1).open()}}),this.registerMarkdownCodeBlockProcessor("encounter",(e,o,t)=>{var n;try{let r=o.createDiv({cls:"encounter-table-container"}),a=r.createEl("table",{cls:"encounter-table"}),s=e.trim().split(`
`),l=!1,i=null,u=null;for(let c=0;c<s.length;c++){let g=s[c].trim();if(!g||g.indexOf("|")===-1||g.replace(/[\|\-\s]/g,"").length===0){g.includes("---")&&(l=!0);continue}let m=!l&&(g.toLowerCase().includes("qty")||g.toLowerCase().includes("creature")),h=g.toLowerCase().includes("total");if(g.includes(":---")){l=!0;continue}let f=a.insertRow();h&&f.addClass("encounter-total-row");let v=g.split("|");for(let y=0;y<v.length;y++){let E=v[y].trim();if((y===0||y===v.length-1)&&E==="")continue;let x=m&&!h,w=f.createEl(x?"th":"td");p.MarkdownRenderer.renderMarkdown(E,w,t.sourcePath,this),w.children.length===1&&((n=w.firstElementChild)==null?void 0:n.tagName)==="P"&&(w.innerHTML=w.firstElementChild.innerHTML)}if(m&&!h)u||(u=a.createTHead()),u.appendChild(f),l=!0;else if(!h)i||(i=a.createTBody()),i.appendChild(f);else{let y=a.tFoot;y||(y=a.createTFoot()),y.appendChild(f),Array.from(f.cells).forEach(E=>E.style.fontWeight="bold")}}let d=this.addDifficultyCalculator(r,e);if(d){let c=d.querySelector(".encounter-controls");if(c){let g=c.createEl("button",{text:"Export Statblocks"});g.addClass("encounter-export-btn"),g.addEventListener("click",async()=>{console.log("--- EB: Export Statblocks button clicked ---");try{await this.exportStatblocksToNote(e,t.sourcePath)}catch(h){console.error("EB: Error initiating statblock export:",h),new p.Notice("Error exporting statblocks. Check console.")}});let m=c.createEl("button",{text:"Edit Encounter"});m.addClass("encounter-edit-btn"),m.addEventListener("click",()=>{console.log("--- EB: Edit button clicked ---");try{let h=X(e),f=t.getSectionInfo(o),v=t.sourcePath;if(!(h!=null&&h.creatures))throw new Error("Could not parse creatures.");new N(this.app,this,!0,h.creatures,f,v).open()}catch(h){console.error("EB: Error parsing source for editing",h),new p.Notice("Could not parse encounter data for editing.")}})}else console.warn("EB: Could not find .encounter-controls to add Edit/Export buttons.")}}catch(r){console.error("EB Error rendering code block:",r),o.createDiv({cls:"encounter-error",text:"Error rendering encounter: "+(r instanceof Error?r.message:String(r))})}}),console.log("--- Encounter Builder: Fully Loaded ---")}onunload(){console.log("Unloading Encounter Builder Plugin")}async loadSettings(){this.settings=Object.assign({},this.DEFAULT_SETTINGS,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}getCRtoXP(e){var o;return(o=this.CR_TO_XP_2024[e])!=null?o:null}addDifficultyCalculator(e,o){let t=e.createDiv({cls:"encounter-difficulty-wrapper"});try{let n=X(o),r=t.createDiv({cls:"encounter-party-form"});r.createEl("label",{text:"Party Size:"});let a=r.createEl("input",{type:"number",value:String(this.lastPartySize)});a.min="1",a.addClass("encounter-party-size"),r.createEl("label",{text:"Avg Level:"});let s=r.createEl("input",{type:"number",value:String(this.lastPartyLevel)});s.min="1",s.max="20",s.addClass("encounter-party-level");let i=t.createDiv({cls:"encounter-controls",attr:{style:"display: flex; gap: 10px; margin-top: 5px; align-items: center;"}}).createEl("button",{text:"Calculate Difficulty"});i.addClass("encounter-calculate-btn");let u=t.createDiv({cls:"encounter-difficulty-results"});return u.style.display="none",i.addEventListener("click",()=>{let d=parseInt(a.value,10),c=parseInt(s.value,10);if(this.lastPartySize=d&&d>=1?d:this.lastPartySize,this.lastPartyLevel=c&&c>=1&&c<=20?c:this.lastPartyLevel,a.value=String(this.lastPartySize),s.value=String(this.lastPartyLevel),this.lastPartySize<1||this.lastPartyLevel<1||this.lastPartyLevel>20){new p.Notice("Enter valid party size/level."),u.style.display="none";return}this.calculateDifficulty(u,n,this.lastPartySize,this.lastPartyLevel),u.style.display="block"}),t}catch(n){return console.error("EB: Error adding difficulty calculator",n),t.createDiv({cls:"encounter-error",text:"Error initializing calculator."}),null}}calculateDifficulty(e,o,t,n){e.empty();let{creatures:r,totalXP:a,totalCR:s,highestCR:l}=o,i={1:{low:50,moderate:75,high:100},2:{low:100,moderate:150,high:200},3:{low:150,moderate:225,high:400},4:{low:250,moderate:375,high:500},5:{low:500,moderate:750,high:1100},6:{low:600,moderate:1e3,high:1400},7:{low:750,moderate:1300,high:1700},8:{low:1e3,moderate:1700,high:2100},9:{low:1300,moderate:2e3,high:2600},10:{low:1600,moderate:2300,high:3100},11:{low:1900,moderate:2900,high:4100},12:{low:2200,moderate:3700,high:4700},13:{low:2600,moderate:4200,high:5400},14:{low:2900,moderate:4900,high:6200},15:{low:3300,moderate:5400,high:7800},16:{low:3800,moderate:6100,high:9800},17:{low:4500,moderate:7200,high:11700},18:{low:5e3,moderate:8700,high:14200},19:{low:5500,moderate:10700,high:17200},20:{low:6400,moderate:13200,high:22e3}};if(n<1||n>20||!i[n]){e.createDiv({cls:"encounter-error",text:"Party level must be 1-20."});return}let u=i[n],d=u.low*t,c=u.moderate*t,g=u.high*t,m,h;a>g?(m="Out of Bounds",h="encounter-deadly"):a>c?(m="High",h="encounter-hard"):a>d?(m="Moderate",h="encounter-medium"):a>=u.low*t?(m="Low",h="encounter-easy"):(m="Below Low",h="encounter-trivial");let f=e.createDiv({cls:"encounter-header-container"});f.createEl("h4",{text:`Difficulty for ${t} level ${n} characters`});let v=e.createDiv({cls:"encounter-content-container"});v.dataset.visible="true";let y=f.createEl("button",{text:"Hide Details",cls:"encounter-toggle-details-button"});y.onclick=()=>{let L=v.dataset.visible==="true";v.dataset.visible=L?"false":"true",y.textContent=L?"Show Details":"Hide Details"};let E=v.createDiv({cls:"encounter-dmg-section"});E.createDiv({cls:"encounter-multiplier-info"}).createEl("p",{text:`Encounter Total XP: ${a.toLocaleString()}`});let x=E.createEl("table",{cls:"encounter-threshold-table"}),w=x.createTHead().insertRow();["Difficulty","Party Budget (Total)","Encounter XP (Total)"].forEach(L=>w.createEl("th",{text:L}));let P=x.createTBody();[{name:"Low",value:d},{name:"Moderate",value:c},{name:"High",value:g}].forEach(L=>{let F=P.insertRow();(L.name==="Low"&&m==="Low"||L.name==="Moderate"&&m==="Moderate"||L.name==="High"&&m==="High")&&F.addClass("encounter-highlighted-row"),F.insertCell().textContent=L.name,F.insertCell().textContent=`Up to ${L.value.toLocaleString()}`;let H=F.insertCell();H.textContent=a.toLocaleString(),L.name===m&&(H.addClass(h),H.style.fontWeight="bold")});let S=P.insertRow();m==="Out of Bounds"&&S.addClass("encounter-highlighted-row"),S.insertCell().textContent="Out of Bounds",S.insertCell().textContent=`> ${g.toLocaleString()}`;let A=S.insertCell();A.textContent=a.toLocaleString(),m==="Out of Bounds"&&(A.addClass(h),A.style.fontWeight="bold");let U=E.createDiv({cls:"encounter-summary"});U.textContent="DMG 2024 Rating: ";let K=U.createEl("span",{text:m});K.addClass(h),K.style.fontWeight="bold";let G=v.createDiv({cls:"encounter-lazy-section",attr:{style:"margin-top: 15px; border-top: 1px solid var(--background-modifier-border); padding-top: 15px;"}});G.createEl("h5",{text:"Lazy DM Benchmark (CR Based)"});let T=G.createDiv({cls:"encounter-lazy-info"}),Q=t*n,Y=n>=5?2:4,I=Q/Y,j=n>=5?1.5:1,k=n*j;T.createEl("p",{text:`Party: ${t} Lvl ${n} (${Q} total)`}),T.createEl("p",{text:`Threshold > CR ${I.toFixed(2)} (1/${Y} levels)`});let tt=T.createEl("p"),et=`Sum CRs: ${s.toFixed(2)}`,B="encounter-easy";s>I?B="encounter-deadly":s>I*.75?B="encounter-hard":s>I*.5&&(B="encounter-medium"),tt.createEl("span",{text:et,cls:B,attr:{style:"font-weight:bold;"}}),T.createEl("p",{text:`Single > CR ${k.toFixed(2)} (${j}x level)`});let nt=T.createEl("p"),st=`Highest CR: ${l.toFixed(2)}`,D="encounter-easy";l>k?D="encounter-deadly":l>k*.75?D="encounter-hard":l>k*.5&&(D="encounter-medium"),nt.createEl("span",{text:st,cls:D,attr:{style:"font-weight:bold;"}});let $=T.createEl("p");$.addClass("encounter-lazy-rating");let R="Easy",M="encounter-easy";s>I||l>k?(R="Potentially Deadly",M="encounter-deadly"):s>I*.75||l>k*.75?(R="Hard",M="encounter-hard"):(s>I*.5||l>k*.5)&&(R="Medium",M="encounter-medium"),$.textContent="Lazy DM Rating: ";let J=$.createEl("span",{text:R});J.addClass(M),J.style.fontWeight="bold",$.style.marginTop="0.5em"}async exportStatblocksToNote(e,o){var t,n,r;new p.Notice("Exporting statblocks...",3e3);try{let a=X(e);if(!((t=a==null?void 0:a.creatures)!=null&&t.length))return;let s=[...new Set(a.creatures.map(E=>{let x=E.name.match(/^\[\[([^|\]]+)(?:\|[^\]]+)?\]\]$/);return x?x[1].trim():E.name.trim()}))];if(s.length===0)return;console.log("EB: Unique creatures for export:",s);let l=`# Encounter Statblocks

`,i=[],u=0;for(let E of s){let x=await this.findCreatureFile(E);if(x instanceof p.TFile){console.log(`
==== Processing: ${E} (${x.path}) ====`);let w=await this.app.vault.cachedRead(x);console.log("Original Content (first 200 chars):\n```\n"+w.substring(0,200)+"\n```");let P=/^---\s*[\s\S]*?\s*---\s*\n?/,V=P.test(w);console.log(`Regex Matched: ${V}`);let S=w.replace(P,"").trim();console.log(`Content After Replace (first 200 chars):
\`\`\`
${S.substring(0,200)}
\`\`\``),l+=`## ${x.basename}

${S}

---

`,u++,console.log("===========================================")}else console.warn(`EB: Could not find statblock file for: ${E}`),i.push(E),l+=`## ${E}

*Statblock not found.*

---

`}let c=`Statblocks - ${(r=(n=this.app.workspace.getActiveFile())==null?void 0:n.basename)!=null?r:"Encounter"}.md`,g="",m=g?`${g}/${c}`:c,h=await this.app.vault.getAvailablePath(m,"md"),f=await this.app.vault.create(h,l);console.log(`EB: Created statblock note: ${f.path}`);let v=`Created note: ${f.basename}`;i.length>0&&(v+=` (${u} found, ${i.length} missing: ${i.join(", ")})`),new p.Notice(v,1e4),await this.app.workspace.getLeaf("tab").openFile(f)}catch(a){console.error("EB: Error during statblock export:",a),new p.Notice("Failed to export statblocks. See console for details.",5e3)}}async findCreatureFile(e){if(!e)return null;let o=e.toLowerCase().trim();try{let t=this.app.vault.getMarkdownFiles(),n=[],r=this.settings,a=[r.monsterLocation1,r.monsterLocation2,r.monsterLocation3].filter(s=>s&&s.trim()!=="").map(s=>s.endsWith("/")?s:s+"/");if(a.length>0&&(n=t.filter(s=>s.basename.toLowerCase()===o&&a.some(l=>s.path.startsWith(l))),n.length>0))return console.log(`EB: Found exact match for '${e}' in locations: ${n[0].path}`),n[0];if(a.length>0){for(let s of a){let l=t.filter(i=>i.basename.toLowerCase().includes(o)&&i.path.startsWith(s));if(l.length>0){let i=l.find(u=>u.basename.toLowerCase()===o);n=i?[i]:l,console.log(`EB: Found partial match(es) for '${e}' in location '${s}'. Using: ${n[0].path}`);break}}if(n.length>0)return n[0]}if(r.searchAllVault){let s=t.filter(l=>l.basename.toLowerCase().includes(o));if(s.length>0){let l=s.find(i=>i.basename.toLowerCase()===o);n=l?[l]:s,console.log(`EB: Found match(es) for '${e}' in vault search. Using: ${n[0].path}`)}}return n.length===0?null:(n.length===1||console.warn(`EB: Multiple files potentially match '${e}'. Returning first found: ${n[0].path}`),n[0])}catch(t){return console.error(`EB: Error in findCreatureFile for ${e}:`,t),null}}async lookupCreatureStats(e){if(!e)return null;let o=e.toLowerCase().trim();try{let t=this.app.vault.getMarkdownFiles(),n=[],r=this.settings,s=[r.monsterLocation1,r.monsterLocation2,r.monsterLocation3].filter(i=>i&&i.trim()!=="").map(i=>i.endsWith("/")?i:i+"/");if(s.length>0&&(n=t.filter(i=>i.basename.toLowerCase()===o&&s.some(u=>i.path.startsWith(u)))),n.length===0&&s.length>0)for(let i of s){let u=t.filter(d=>d.basename.toLowerCase().includes(o)&&d.path.startsWith(i));if(u.length>0){n=u;break}}if(n.length===0&&r.searchAllVault){n=t.filter(u=>u.basename.toLowerCase().includes(o));let i=n.filter(u=>u.basename.toLowerCase()===o);i.length>0&&(n=i)}if(n.length===0)return console.log(`EB: Not found: ${e}`),new p.Notice(`Not found: ${e}`),null;let l=null;if(n.length>1){let i=["**AC**","**HP**","**CR**","{{stats","{{vitals","Challenge","hit points"],u=n.map(async c=>{try{let g=await this.app.vault.cachedRead(c);return i.some(m=>g.includes(m))?c:null}catch(g){return null}}),d=(await Promise.all(u)).filter(c=>c!==null);if(d.length===1)l=d[0];else{let c=d.length>1?d:n;return new Promise(g=>{let m=!1,h=new _(this.app,this,c,async v=>{m||(m=!0,g(await this.processCreatureFile(v)))}),f=h.onClose.bind(h);h.onClose=()=>{f(),m||(m=!0,console.log("EB: Select modal cancelled."),g(null))},h.open()})}}else l=n[0];return l?await this.processCreatureFile(l):(console.log(`EB: No file determined for ${e}`),null)}catch(t){return console.error(`EB Error lookup ${e}:`,t),new p.Notice(`Error lookup: ${e}`),null}}async processCreatureFile(e){try{let o=await this.app.vault.cachedRead(e),t=this.parseCreatureStats(o,e.basename,e.path),n="Custom";return e.path.includes("2024_z_compendium")?n="2024":e.path.includes("z_compendium")&&(n="Classic"),t?(t.source=n,t):new Promise(r=>{let a=!1,s=new O(this.app,this,e.basename,i=>{a||(a=!0,r(i))}),l=s.onClose.bind(s);s.onClose=()=>{l(),a||(a=!0,console.log("EB: Manual modal cancelled."),r(null))},s.open()})}catch(o){return console.error(`EB Error process ${e.path}:`,o),new p.Notice(`Error process: ${e.basename}`),null}}parseCreatureStats(e,o="Unknown",t=null){var n,r;try{let a=/(?:(?:\*\*|__)Challenge(?:\*\*|__)\s*:?|Challenge\s+Rating\s*:?)\s*([0-9\/]+)\s*\(([0-9,]+\s*XP)\)/i,s=e.match(a);if(s!=null&&s[1]&&s[2]){let d=s[1].trim(),c=parseInt(s[2].replace(/,/g,"").replace(/\s*XP/i,"").trim(),10);if(d&&!isNaN(c))return{cr:d,xp:c}}let l=/\*\*CR\*\*[\s:]*::?[\s:]*([0-9\/]+)/i;if(s=e.match(l),s!=null&&s[1]){let d=s[1].trim(),c=this.getCRtoXP(d);if(c!==null)return{cr:d,xp:c}}let i=/\*\*CR\*\*.*?([0-9\/]+)/i;if(s=e.match(i),s!=null&&s[1]){let d=s[1].trim(),c=this.getCRtoXP(d);if(c!==null)return{cr:d,xp:c}}if(t){let d=this.app.vault.getAbstractFileByPath(t);if(d instanceof p.TFile){let c=this.app.metadataCache.getFileCache(d);if(c!=null&&c.frontmatter){let g=c.frontmatter,m=g.cr!==void 0?String(g.cr).trim():null,h=null;if(g.xp!==void 0){let f=parseInt(String(g.xp).replace(/,/g,""),10);isNaN(f)||(h=f)}if(m&&(h===null&&(h=this.getCRtoXP(m)),h!==null))return{cr:m,xp:h}}}}let u=/^---\s*([\s\S]*?)\s*---/;if(s=e.match(u),s!=null&&s[1]){let d=s[1],c=d.match(/^(?:cr|challenge):\s*['"]?([0-9\/]+)['"]?/im),g=d.match(/^xp:\s*['"]?([0-9,]+)['"]?/im),m=(r=(n=c==null?void 0:c[1])==null?void 0:n.trim())!=null?r:null,h=g!=null&&g[1]?parseInt(g[1].replace(/,/g,""),10):null;if(m&&((h===null||isNaN(h))&&(h=this.getCRtoXP(m)),h!==null&&!isNaN(h)))return{cr:m,xp:h}}return e.includes("{{monster")&&(e.includes("spell's level")||e.includes("upcast"))?{cr:"Varies",xp:0}:(console.warn(`EB: Could not parse CR/XP for ${o}. Path: ${t!=null?t:"N/A"}`),null)}catch(a){return console.error(`EB: Error parsing stats for ${o}:`,a),null}}},pt=W;
